{% extends "main/base.html" %}
{% load staticfiles %}
{% load humanize %}

{% block title %} 오픈아레나:{{ tournament.tournament_name }} {% endblock %}
{% block head %}
    <!--participation.css-->
    <link rel="stylesheet" href="{% static 'css/participation.css' %}">
    <link rel="stylesheet" href="{% static 'css/contents_deco.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom_kyoungin.css' %}">
{% endblock %}
{% block content %}
    <div class="block-b">
        <div class="com_header" style="background:url('https://s3.ap-northeast-2.amazonaws.com/openarena/admin/images/custom/whyachi_cover.png') center center no-repeat; background-size: cover;">
            <div class="com_empty">
            </div>
            <div class="com_header_inner">
                <div class="container">
                    <!--프로필칸-->
                    <div class="col-sm-3 col-md-2 col-md-offset-1 hidden-xs" >
                        <div class="com_profile" style="background: url('https://s3.ap-northeast-2.amazonaws.com/openarena/admin/images/common/lol_logo.png'); background-size: contain;"></div>
                    </div>
                    <!--대회설명-->
                    <div class="col-sm-6 col-md-6 col-xs-12 ">
                        <div class="com_title">{{ tournament.tournament_name }}</div><br/>
                        <p class="com_subtitle hidden-xs">{{ tournament.summary }}</p>
                        <div class="com_subtitle">대회 일정 : {{ tournament.starttime }}</div><br/>
                    </div>
                    <!--후원/참가-->
                    <div class="col-sm-3 col-md-3 col-xs-12 ">
                        <ul class="com_mainbox">
                            <li class="">
                                <div class="" >
                                    <div class="center">
                                        <button disabled id="participation" name="participation" class="btn btn-primary center-block" data-toggle="modal" data-target="#participationModal">참가 마감</button>
                                    </div>
                                </div>
                                <div class="hidden-xs" style="height: 20px"></div>
                                <div class="" >
                                    <div class="center">
                                        <button disabled id="funding" name="funding" class="btn btn-primary center-block" data-toggle="modal" data-target="#fundingModal">후원 마감</button>
                                    </div>
                                </div>
                                <div class="hidden-xs" style="height: 20px"></div>
                                <div class="center">
                                    <button id="streaming" name="streaming" class="btn btn-primary center-block">방송 보기</button>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!--상금바-->
                    <div class="col-sm-10 col-md-10 col-xs-10 col-md-offset-1 ">
                        <h4 id="comma1" class="com_title">
                            후원 목표 : {{ tournament.funding_goal|intcomma }}원 / 현재 : {{ total_amount.amount__sum|intcomma }}원 후원 해주셨습니다
                        </h4>
                        <p class="com_subtitle">* 홈페이지 후원 금액과 후원자 명단은 30분 마다 갱신됩니다.</p>
                        <!--
                        <div class="com_white_bar">
                            <div class="com_orange_bar"></div>
                        </div>
                        -->
                    </div>
                </div>

            </div>
        </div>
        <div class="com_mid">
            <!--competition list-->
            <div class="btn-pref btn-group btn-group-justified btn-group-lg" role="group" aria-label="...">
                <!-- 대회 영상 -->
                <div class="btn-group" role="group">
                    <button type="button" id="following" class="btn btn-primary no_border" href="#com_tab6" data-toggle="tab">
                        <span class="list_btn">대회 영상</span>
                    </button>
                </div>
                <!-- 대회 소개 -->
                <div class="btn-group" role="group">
                    <button type="button" id="stars" class="btn btn-custom no_border " href="#com_tab1" data-toggle="tab">
                        <span class="list_btn">대회 소개</span>
                    </button>
                </div>
                <!-- 참여한 대회 -->
                <div class="btn-group" role="group">
                    <button type="button" id="following" class="btn btn-custom no_border" href="#com_tab3" data-toggle="tab">
                        <span class="list_btn">참가자</span>
                    </button>
                </div>
                <!-- 후원자 명단 -->
                <div class="btn-group" role="group">
                    <button type="button" id="following" class="btn btn-custom no_border" href="#com_tab5" data-toggle="tab">
                        <span class="list_btn">후원자 명단</span>
                    </button>
                </div>
            </div>
            <!--competition list-->
            <!--competition content-->
            <div class="tab-content">
                <!--competition content 1-->
                <div class="tab-pane fade in" id="com_tab1">
                    <div class="com_intro">
                        <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                            <div class="com_intro_img">
                                <img src="https://s3.ap-northeast-2.amazonaws.com/openarena/admin/images/custom/whyachi_poster.jpeg">
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                            <div class="container com_intro_now">
                                {% if participation %}
                                    <div class="com_into_small">참가자 수</div>
                                    <div class="com_into_small"><span class="com_into_big">{{ participation.count }}</span> 명</div><br>
                                {% else %}
                                    <div class="com_into_small">참가자 수</div>
                                    <div class="com_into_small"><span class="com_into_big">0</span> 명</div><br>
                                {% endif %}
                                <div class="com_into_small">참가 기한</div>
                                <div class="com_into_small"><span class="com_into_big">{{ tournament.participation_endtime }}</span> 일</div><br>
                                {% if funding %}
                                    <div class="com_into_small">후원자 수</div>
                                    <div class="com_into_small"><span class="com_into_big">{{ funding.count }}</span> 명</div><br>
                                    <div class="com_into_small">후원 상금</div>
                                    <div class="com_into_small"><span class="com_into_big">{{ total_amount.amount__sum|intcomma }}</span> 원</div><br>
                                {% else %}
                                    <div class="com_into_small">후원자 수</div>
                                    <div class="com_into_small"><span class="com_into_big">0</span> 명</div><br>
                                    <div class="com_into_small">모인 상금</div>
                                    <div class="com_into_small"><span class="com_into_big">0</span> 원</div><br>
                                {% endif %}
                                <div class="com_into_small">
                                    <!-- Go to www.addthis.com/dashboard to customize your tools -->
                                    <div class="addthis_inline_share_toolbox"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                            <div class="com_intro_desp">
                                <input type="hidden" id="edit" class="btn btn-default" type="button" value="수정하기">
                                <div id="description" class="summernote">{{ tournament.description|safe }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--competition content 3 대진표-->
                <div class="tab-pane fade in" id="com_tab3">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="com_intro_desp">
                            <img src="https://s3.ap-northeast-2.amazonaws.com/openarena/admin/images/custom/whyachi_match_final.png" style="max-width: 100%; height: auto;">
                        </div>
                        <div class="com_intro_desp">
                            <a class="donator_title">대회 신청자</a>
                            <br/>
                            {% if participation %}
                                <a style="color: white">현재 {{ participation.count }} 명</a>
                            {% else %}
                                <a style="color: white">현재 0 명</a>
                            {% endif %}

                            <div class="donator_container">
                                <table class="table table-striped table-list">
                                    <thead>
                                    <tr>
                                        <th>번호</th>
                                        <th>오픈아레나 닉네임</th>
                                        <th>티어</th>
                                        <th>롤 닉네임</th>
                                        <th>참가 여부</th>
                                        <th>체크인</th>
                                        <th>결과</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if participation %}
                                        {% for p in participation %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ p.username }}</td>
                                                <td>{{ p.etc1 }}</td>
                                                <td>{{ p.etc2 }}</td>
                                                <td>{{ p.confirm }}</td>
                                                <td>{{ p.checkin }}</td>
                                                <td>{{ p.result }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!--competition content 5 후원자 명단-->
                <div class="tab-pane fade in" id="com_tab5">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 ">
                        <div class="com_intro_desp">
                            <p class="don_list">* 홈페이지 후원 금액과 후원자 명단은 30분 마다 갱신됩니다.</p>
                        </div>
                        <div class="com_intro_desp">
                            <a class="donator_title">Top3 후원자</a>
                            <div class="donator_container">
                                <table class="table table-striped table-list">
                                    <thead>
                                    <tr>
                                        <th>번호</th>
                                        <th>후원자 닉네임</th>
                                        <th>후원 금액</th>
                                        <th>보상</th>
                                        <th>응원 문구</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if funding %}
                                        {% for tf in top_funding %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ tf.username }} 님</td>
                                                <td>{{ tf.amount|intcomma }}원</td>
                                                <td>{{ tf.reward }}</td>
                                                <td>{{ tf.comment }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="com_intro_desp">
                            <a class="donator_title">후원해주신 분들</a>
                            <br>
                            <a style="color: white">현재 {{ funding.count }} 명</a>
                            <div class="donator_container">
                                <table class="table table-striped table-list">
                                    <thead>
                                    <tr>
                                        <th>번호</th>
                                        <th>후원자 닉네임</th>
                                        <th>후원 금액</th>
                                        <th>보상</th>
                                        <th>응원 문구</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% if funding %}
                                        {% for f in funding %}
                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>{{ f.username }} 님</td>
                                                <td>{{ f.amount|intcomma }}원</td>
                                                <td>{{ f.reward }}</td>
                                                <td>{{ f.comment }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!--video content-->
                <div class="tab-pane fade in active" id="com_tab6">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <div class="com_intro_desp">
                            <div class="contents_video" >
                                <div class="contents_video_ul"><!--업로드한 동영상-->
                                    <div >
                                        <select class="form-control input-sm control">
                                            <option selected>최신순</option>
                                            <option>조회순</option>
                                            <option>댓글순</option>
                                        </select>
                                        <div class="upload">대회 영상 모음</div>
                                    </div>
                                    <div class="video_bar"></div>
                                    {% if video %}
                                        {% for v in video %}
                                            <div>{{ v.video_name }}</div>
                                            <div class="youtube" data-id="{{ v.video_url }}"></div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!--competition content-end-->

            <!--donate-->
            <div class="modal fade" id="fundingModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                            <h3 class="modal-title" id="lineModalLabel">대회 후원하기</h3>
                        </div>
                        <div class="modal-body">
                            <!-- content goes here -->
                            <form id="funding_form" action="{% url 'whyachi' %}" method="POST">{% csrf_token %}
                                <div class="form-group">
                                    <label for="exampleInputPassword1">후원하실 금액을 선택해주세요.</label>
                                </div>
                                <input type="hidden" class="donate_submit" id="purpose" name="purpose" value="funding">
                                <select id="funding_amount" name="funding_amount" class="form-control">
                                    <option value="1000">1,000원</option>
                                    <option value="3000">3,000원</option>
                                    <option value="5000">5,000원</option>
                                    <option value="10000">10,000원</option>
                                    <option value="20000">20,000원</option>
                                    <option value="50000">50,000원 [혜택 : BJ아치의 롤 게임 코칭 제공]</option>
                                </select>
                                <br/>
                                * 팝업 기능을 허용해주셔야하며, 모바일이 아닌 PC환경에서 후원 가능한 점을 양해부탁드립니다.<br/>
                                * 후원해주신 분들 모두 댓글 등록이 가능하며 게임 영상 감사 크레딧에 소개될 예정입니다.
                                <button type="submit" class="join_submit">후원하기</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!--participation in-->
            <div class="modal fade" id="participationModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                            <h3 class="modal-title" id="lineModalLabel">대회 참가하기</h3>
                        </div>
                        <div class="modal-body">
                            <!-- content goes here -->
                            <form id="participation_form" action="{% url 'whyachi' %}" method="POST">{% csrf_token %}
                                <input type="hidden" class="form-control" id="purpose" name="purpose" value="participation">
                                <div class="form-group">
                                    <label for="participation_username">참가자 성함 (상금 지급 및 대회 참가 확인을 위함)</label>
                                    <input required autocomplete="off" class="form-control" id="participation_name" name="participation_name" placeholder="예) 홍길동">
                                </div>
                                <div class="form-group">
                                    <label for="participation_etc2">롤 아이디</label>
                                    <input required autocomplete="off" class="form-control" id="participation_etc2" name="participation_etc2" placeholder="예) 롤길동">
                                </div>
                                <div class="form-group">
                                    <label for="participation_etc1">롤 티어</label>
                                    <input required autocomplete="off" class="form-control" id="participation_etc1" name="participation_etc1" placeholder="예) 실버 1티어">
                                </div>
                                <div class="form-group">
                                    <label for="participation_phone">참가자 연락처 (상금 지급 및 대회 참가 확인을 위함)</label>
                                    <input required autocomplete="off" class="form-control" id="participation_phone" name="participation_phone" placeholder="예) 010-1234-5678">
                                </div>
                                * 참가 완료 확인 후 단체 카톡방 링크를 연락처로 보내드리도록 하겠습니다.
                                <br/>
                                <button type="submit" class="join_submit">참가하기</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
    <script>
        $(document).ready(function(){
            $(".btn-pref .btn").click(function(){
                $(".btn-pref .btn").removeClass("btn-primary").addClass("btn-custom");
                // $(".tab").addClass("active"); // instead of this do the below
                $(this).removeClass("btn-custom").addClass("btn-primary");
            });

            $("#streaming").click(function(){
                window.open("{{ tournament.streaming_url_spec }}");
            });

            $("#funding_form").submit(function(e){
                e.preventDefault();
                serializedData = $("#funding_form").serialize();
                $.ajax({
                    type: 'POST',
                    url: '/whyachi/',
                    data: serializedData,
                    dataType: 'json',
                    success: function(response){
                        window.open(response.status)
                    }
                });
            });

            $("#participation_form").submit(function(e){
                e.preventDefault();
                serializedData = $("#participation_form").serialize();
                $.ajax({
                    type: 'POST',
                    url: '/whyachi/',
                    data: serializedData,
                    dataType: 'json',
                    success: function(response){
                        if(response.status == "success"){
                            alert('대회 참가 신청이 정상적으로 제출되었습니다.');
                            location.reload();
                        }
                    }
                });
            });

            var click = 0;
            $("#edit").click(function(e){
                if(click==0){
                    /* 클릭시 창 켜지기 */
                    $('.summernote').summernote({focus: true});
                    document.getElementById("edit").value="저장하기";
                    click = 1;
                } else if(click==1){
                    /* 저장하기 */
                    e.preventDefault();
                    var serializedData = {
                        "purpose": "description",
                        "description": $('.summernote').summernote('code')
                    };
                    $.ajax({
                        type: 'POST',
                        url: '/whyachi/',
                        data: serializedData,
                        dataType: 'json',
                        success: function(response) {
                            $('.summernote').summernote('destroy');
                            document.getElementById("edit").value="수정하기";
                            click = 0;
                        }
                    });
                }
            });
        });
    </script>

    {% include 'main/functions/light-youtube-embed.html' %}

    <!-- Go to www.addthis.com/dashboard to customize your tools -->
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57d75e1fa49a7bd2"></script>

{% endblock %}
